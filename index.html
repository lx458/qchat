<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>量子计算VQE算法对话平台（混合AI版）</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .user-bubble { background-color: #4338ca; color: white; border-radius: 1.25rem 1.25rem 0.25rem 1.25rem; padding: 0.75rem 1rem; margin: 0.5rem 0; max-width: 70%; align-self: flex-end; word-wrap: break-word; box-shadow: 0 4px 12px rgba(67, 56, 202, 0.2); }
        .ai-bubble { background-color: #f3f4f6; color: #1f2937; border-radius: 1.25rem 1.25rem 1.25rem 0.25rem; padding: 0.75rem 1rem; margin: 0.5rem 0; max-width: 70%; align-self: flex-start; word-wrap: break-word; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); }
        .loading-bubble { background-color: #f3f4f6; color: #1f2937; border-radius: 1.25rem 1.25rem 1.25rem 0.25rem; padding: 0.75rem 1rem; margin: 0.5rem 0; max-width: 20%; align-self: flex-start; display: flex; align-items: center; gap: 0.5rem; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #e5e7eb; border-radius: 3px; }
        ::-webkit-scrollbar-thumb { background-color: #9ca3af; border-radius: 3px; }
        /* 修复Tab切换的CSS逻辑 */
        .tab-content {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            opacity: 0;
            transform: translateY(10px);
            display: none; /* 默认隐藏 */
        }
        .tab-content.active {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }
        /* 单独处理AI对话Tab的flex显示 */
        #chat.tab-content.active {
            display: flex;
        }
        .api-key-input { border: 1px solid #ddd; border-radius: 0.5rem; padding: 0.5rem; width: 100%; margin-top: 0.5rem; }
        .api-hint { font-size: 0.875rem; color: #6b7280; margin-top: 0.25rem; }
        .code-block { background-color: #1f2937; color: #f9fafb; padding: 1rem; border-radius: 0.5rem; overflow-x: auto; font-family: 'Courier New', Courier, monospace; margin: 0.5rem 0; }
        .formula { font-style: italic; color: #4338ca; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col text-gray-800">
    <!-- 导航栏 -->
    <nav class="bg-indigo-800 text-white p-4 shadow-lg">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold tracking-tight">量子计算 VQE 算法（混合AI版）</h1>
            <div class="space-x-1 md:space-x-2">
                <!-- 修复按钮的onclick逻辑，确保类名匹配 -->
                <button onclick="switchTab('intro')" class="hover:bg-indigo-700 px-4 py-2 rounded-lg transition-all duration-200 flex items-center gap-2">
                    <i class="fa-solid fa-book"></i>算法介绍
                </button>
                <button onclick="switchTab('h2calc')" class="hover:bg-indigo-700 px-4 py-2 rounded-lg transition-all duration-200 flex items-center gap-2">
                    <i class="fa-solid fa-flask"></i>氢分子计算
                </button>
                <button onclick="switchTab('chat')" class="hover:bg-indigo-700 px-4 py-2 rounded-lg transition-all duration-200 flex items-center gap-2">
                    <i class="fa-solid fa-comments"></i>AI对话
                </button>
            </div>
        </div>
    </nav>

    <!-- 主要内容区 -->
    <main class="container mx-auto flex-1 p-4 md:p-8">
        <!-- 1. 算法介绍Tab（修复类名：active） -->
        <div id="intro" class="tab-content active">
            <div class="bg-white rounded-2xl shadow-lg p-6 md:p-8 mb-8">
                <h2 class="text-2xl font-bold text-indigo-700 mb-6 flex items-center gap-3"><i class="fa-solid fa-atom"></i>VQE 算法核心原理</h2>
                <div class="grid md:grid-cols-1 gap-8">
                    <div>
                        <h3 class="text-xl font-semibold mb-3 text-gray-700">什么是 VQE？</h3>
                        <p class="text-gray-600 mb-6 leading-relaxed">变分量子本征求解器（VQE）是量子-经典混合算法，用于求解分子体系的基态能量，是 NISQ 时代的核心量子化学算法。</p>
                        
                        <h3 class="text-xl font-semibold mb-3 text-gray-700">核心流程</h3>
                        <ol class="list-decimal list-inside text-gray-600 space-y-2 mb-6 pl-2">
                            <li>构造参数化量子电路（Ansatz）制备试验波函数</li>
                            <li>测量哈密顿量的期望值 </li>
                            <li>经典优化器更新参数，最小化能量</li>
                            <li>迭代收敛，得到基态能量</li>
                        </ol>
                        
                        <h3 class="text-xl font-semibold mb-3 text-gray-700">为何适用于量子化学？</h3>
                        <ul class="list-disc list-inside text-gray-600 space-y-2 pl-2">
                            <li>解决经典计算机的"维度灾难"（指数级增长的哈密顿量维度）</li>
                            <li>仅需浅层量子电路，适配 NISQ 硬件（噪声大、相干时间短）</li>
                        </ul>
                    </div>
                    <div class="bg-gradient-to-br from-indigo-500 to-purple-600 p-6 rounded-xl border border-gray-200 flex flex-col justify-center text-white">
                        <h3 class="text-xl font-semibold mb-4 text-center">核心思想</h3>
                        <p class="text-center text-lg font-medium leading-relaxed">
                            <i class="fa-solid fa-atom mr-2"></i>
                            <span class="font-bold">量子-经典混合</span>
                            <br>
                            量子处理器负责态制备与测量，经典计算机负责优化迭代，强强联合，高效求解。
                        </p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-2xl shadow-lg p-6 md:p-8">
                <h2 class="text-2xl font-bold text-indigo-700 mb-6 flex items-center gap-3"><i class="fa-solid fa-code"></i>DeepQuantum 安装指南</h2>
                <pre class="bg-gray-900 text-gray-100 p-4 md:p-6 rounded-xl overflow-x-auto text-sm leading-relaxed font-mono">
# 1. 创建并激活 Conda 环境
conda create -n dqenv python=3.12 -y
conda activate dqenv

# 2. 安装 PyTorch
pip install torch

# 3. 安装 DeepQuantum（二选一）
# 基础版
pip install deepquantum
# 开发者版
pip install deepquantum[dev]</pre>
            </div>
        </div>

        <!-- 2. 氢分子计算Tab（默认隐藏） -->
        <div id="h2calc" class="tab-content">
            <div class="bg-white rounded-2xl shadow-lg p-6 md:p-8">
                <h2 class="text-2xl font-bold text-indigo-700 mb-6 flex items-center gap-3"><i class="fa-solid fa-molecule-water"></i>氢分子（H₂）基态能量计算</h2>
                <div class="grid md:grid-cols-2 gap-8">
                    <div>
                        <h3 class="text-xl font-semibold mb-4 text-gray-700">氢分子哈密顿量</h3>
                        <div class="bg-indigo-50 border border-indigo-200 p-5 rounded-xl mb-6">
                            <p class="text-gray-700 font-mono text-lg">H = -1.05237·(I⊗I) + 0.39794·(I⊗Z)</p>
                            <p class="text-gray-700 font-mono text-lg mt-1">  - 0.39794·(Z⊗I) - 0.01128·(Z⊗Z)</p>
                            <p class="text-gray-700 font-mono text-lg mt-1">  + 0.18093·(X⊗X)</p>
                        </div>
                        <p class="text-gray-600 italic">通过量子化学软件（如 PySCF）结合量子比特化（如 Jordan-Wigner 变换）得到。</p>
                    </div>
                    <div>
                        <h3 class="text-xl font-semibold mb-4 text-gray-700">能量收敛曲线</h3>
                        <div class="h-72 bg-gray-50 p-4 rounded-xl border border-gray-200">
                            <canvas id="energyChart"></canvas>
                        </div>
                        <div class="bg-green-50 border border-green-200 p-5 rounded-xl mt-6">
                            <h3 class="text-lg font-semibold mb-2 text-gray-700">计算结果</h3>
                            <p class="text-gray-700 mb-1">最终收敛基态能量：<span class="font-bold text-green-700 text-xl">-1.137 Ha</span></p>
                            <p class="text-gray-600 text-sm">（1 Hartree ≈ 27.211 eV，实验值约 -1.136 Ha，误差小于 0.1%）</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 3. 混合AI对话Tab（默认隐藏） -->
        <div id="chat" class="tab-content" style="flex-direction: column; height: 80vh; max-height: 800px;">
            <div class="bg-white rounded-2xl shadow-lg p-4 md:p-6 mb-6 flex-1 overflow-y-auto flex flex-col" id="chat-history">
                <div class="ai-bubble">
                    你好！我是量子计算 VQE 算法AI助手（混合模式）。
                    <br><br>
                    <strong>使用说明：</strong>
                    <ul class="list-disc pl-5 mt-2 space-y-1">                     
                        <li>如果你输入 <strong>API密钥</strong>，我将切换到更强大的AI模式，为你提供更智能的解答。</li>
                    </ul>
                    请问有什么可以帮助你的吗？
                </div>
            </div>
            <div class="flex flex-col gap-4">
                <!-- API密钥输入区 -->
                <div class="bg-gray-50 p-4 rounded-lg">
                    <label class="font-medium text-gray-700 flex items-center gap-2"><i class="fa-solid fa-key"></i>通义千问 API 密钥 (可选)</label>
                    <input type="password" id="qwen-api-key" placeholder="sk-xxx... (留空则使用内置AI)" class="api-key-input focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <p class="api-hint">
                        密钥获取：<a href="https://dashscope.console.aliyun.com/" target="_blank" class="text-indigo-600 hover:underline">通义千问开放平台</a>
                    </p>
                </div>
                <!-- 问题输入区 -->
                <div class="flex space-x-3">
                    <input type="text" id="user-input" placeholder="输入你的问题..." class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent text-gray-700">
                    <button id="send-button" class="bg-indigo-700 text-white px-6 py-3 rounded-lg hover:bg-indigo-800 transition-colors flex items-center gap-2 font-semibold"><i class="fa-solid fa-paper-plane"></i>发送</button>
                </div>
                <!-- 快速提问 -->
                <div class="flex flex-wrap gap-2">
                    <span class="text-sm text-gray-500 font-medium">快速提问:</span>
                    <button class="quick-question-btn bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded-lg text-sm text-gray-700 transition-colors" data-question="什么是VQE算法？">什么是VQE？</button>
                    <button class="quick-question-btn bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded-lg text-sm text-gray-700 transition-colors" data-question="如何用DeepQuantum实现VQE？">DeepQuantum实现VQE？</button>
                    <button class="quick-question-btn bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded-lg text-sm text-gray-700 transition-colors" data-question="VQE如何处理量子噪声？">VQE如何处理噪声？</button>
                </div>
            </div>
        </div>
    </main>

    <footer class="bg-indigo-800 text-white p-6 mt-auto">
        <div class="container mx-auto text-center text-gray-300">
            <p>量子计算 VQE 算法混合AI平台 &copy; 2024</p>
        </div>
    </footer>

<script>
    // 确保页面加载完成后再执行初始化
    document.addEventListener('DOMContentLoaded', () => {
        // 初始化能量图表（增加错误捕获，避免影响其他功能）
        try {
            initEnergyChart();
        } catch (e) {
            console.warn("能量图表初始化失败（不影响Tab切换）:", e);
        }
        initEventListeners();
    });

    // --- 初始化和UI相关函数 ---
    function initEnergyChart() {
        const ctx = document.getElementById('energyChart').getContext('2d');
        new Chart(ctx, {
            type: 'line', 
            data: { 
                labels: Array.from({length: 50}, (_, i) => i+1), 
                datasets: [{ 
                    label: '能量值（Hartree）', 
                    data: [-0.8, -0.85, -0.92, -0.98, -1.03, -1.07, -1.09, -1.11, -1.12, -1.125, -1.13, -1.132, -1.134, -1.135, -1.136, -1.1365, -1.1368, -1.1369, -1.137, -1.137, -1.137, -1.137, -1.137, -1.137, -1.137, -1.137, -1.137, -1.137, -1.137, -1.137, -1.137, -1.137, -1.137, -1.137, -1.137, -1.137, -1.137, -1.137, -1.137, -1.137, -1.137, -1.137, -1.137, -1.137, -1.137, -1.137, -1.137, -1.137, -1.137, -1.137], 
                    borderColor: '#4338ca', 
                    backgroundColor: 'rgba(67, 56, 202, 0.1)', 
                    borderWidth: 3, 
                    pointBackgroundColor: '#4338ca', 
                    pointBorderColor: '#fff', 
                    pointHoverRadius: 6, 
                    pointRadius: 4, 
                    tension: 0.4, 
                    fill: true 
                }] 
            }, 
            options: { 
                responsive: true, 
                maintainAspectRatio: false, 
                scales: { 
                    y: { title: { display: true, text: '能量（Hartree）', font: { size: 14 } }, grid: { color: 'rgba(0, 0, 0, 0.05)' } }, 
                    x: { title: { display: true, text: '迭代次数', font: { size: 14 } }, grid: { display: false } } 
                }, 
                plugins: { 
                    legend: { display: false }, 
                    tooltip: { backgroundColor: '#1f2937', titleFont: { size: 14, weight: 'bold' }, bodyFont: { size: 12 }, padding: 12, cornerRadius: 8, displayColors: false } 
                } 
            }
        });
    }

    function initEventListeners() {
        document.getElementById('send-button').addEventListener('click', sendMessage);
        document.getElementById('user-input').addEventListener('keypress', (e) => e.key === 'Enter' && sendMessage());
        document.querySelectorAll('.quick-question-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.getElementById('user-input').value = btn.dataset.question;
                sendMessage();
            });
        });
    }

    // --- 修复后的Tab切换函数 ---
    function switchTab(tabId) {
        // 隐藏所有Tab
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.remove('active');
        });
        // 显示目标Tab
        const targetTab = document.getElementById(tabId);
        if (targetTab) {
            targetTab.classList.add('active');
        }
    }

    function addMessageToChat(sender, content, isHtml = false) {
        const chatHistory = document.getElementById('chat-history');
        const bubble = document.createElement('div');
        bubble.className = sender === 'user' ? 'user-bubble' : 'ai-bubble';
        
        if (isHtml) {
            bubble.innerHTML = marked.parse(content);
        } else {
            bubble.textContent = content;
        }
        
        chatHistory.appendChild(bubble);
        chatHistory.scrollTop = chatHistory.scrollHeight;
        return bubble;
    }

    function typeWriterEffect(element, text, i = 0, speed = 20) {
        if (i < text.length) {
            element.innerHTML = text.substring(0, i + 1) + '<span class="animate-pulse">_</span>';
            i++;
            setTimeout(() => typeWriterEffect(element, text, i, speed), speed);
        } else {
            element.innerHTML = text;
        }
    }

    // --- AI核心逻辑 ---
    async function sendMessage() {
        const userInput = document.getElementById('user-input').value.trim();
        const apiKey = document.getElementById('qwen-api-key').value.trim();

        if (!userInput) return;

        addMessageToChat('user', userInput);
        document.getElementById('user-input').value = '';

        if (apiKey && apiKey.startsWith('sk-')) {
            await callRealAI(userInput, apiKey);
        } else {
            callLocalAI(userInput);
        }
    }

    function callLocalAI(userInput) {
        const botReply = getBotResponse(userInput);
        const aiBubble = addMessageToChat('ai', '');
        typeWriterEffect(aiBubble, botReply);
    }

    async function callRealAI(userInput, apiKey) {
        const loadingBubble = addMessageToChat('ai', '<i class="fa-solid fa-spinner fa-spin mr-2"></i>正在连接通义千问...');

        try {
            const response = await fetch('https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                body: JSON.stringify({
                    model: 'qwen-turbo',
                    input: {
                        messages: [{ role: 'system', content: '你是量子计算和VQE算法专家，请用专业、准确且易懂的中文回答用户的问题。' }, { role: 'user', content: userInput }]
                    },
                    parameters: { temperature: 0.7, result_format: 'markdown', max_tokens: 1500 }
                })
            });

            loadingBubble.remove();

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ message: '无法解析错误响应' }));
                throw new Error(errorData.error?.message || `API请求失败，状态码: ${response.status}`);
            }

            const data = await response.json();
            const aiReply = data.output?.choices?.[0]?.message?.content || 'AI回复格式异常。';
            
            const aiBubble = addMessageToChat('ai', '');
            typeWriterEffect(aiBubble, aiReply, 0, 10);

        } catch (error) {
            addMessageToChat('ai', `❌ 调用AI失败: ${error.message}`, true);
        }
    }
    
    // --- 本地AI知识库 ---
    const knowledgeBase = [
        {
            patterns: ["你好", "嗨", "hello", "hi"],
            responses: ["你好！有什么关于VQE算法的问题可以问我。", "你好！很高兴为你服务。", "嗨！请问有什么可以帮助你的吗？"]
        },
        {
            patterns: ["什么是VQE", "解释VQE", "VQE算法"],
            responses: [
                "VQE，即变分量子本征求解器（Variational Quantum Eigensolver），是一种量子-经典混合算法，用于在NISQ设备上求解量子化学和材料科学中的基态能量问题。",
                "VQE是量子化学领域的一种核心算法。它结合了量子计算机的计算能力和经典计算机的优化能力，能够有效地寻找分子的基态能量。其核心思想是利用量子电路制备参数化的试探波函数，并通过经典优化器迭代调整参数，使体系能量最小化。"
            ]
        },
        {
            patterns: ["VQE的步骤", "VQE流程", "VQE怎么工作"],
            responses: [
                "VQE的基本流程如下：\n1. **量子比特化**：将分子哈密顿量H映射到量子比特算符。\n2. **构造Ansatz**：设计一个参数化的量子电路来制备试探波函数|ψ(θ)⟩。\n3. **能量测量**：在量子计算机上多次运行电路，测量哈密顿量的期望值 E(θ) = ⟨ψ(θ)|H|ψ(θ)⟩。\n4. **经典优化**：将测量得到的能量E(θ)反馈给经典优化器，优化器给出一组新的参数θ'。\n5. **迭代**：重复步骤3和4，直到能量E(θ)收敛到最小值，这个最小值就是体系的近似基态能量。"
            ]
        },
        {
            patterns: ["DeepQuantum", "如何安装DeepQuantum", "DQ框架"],
            responses: [
                "DeepQuantum是一个基于PyTorch的开源量子机器学习框架。\n\n**安装步骤**：\n```bash\n# 1. 创建并激活Conda环境\nconda create -n dqenv python=3.9 -y\nconda activate dqenv\n\n# 2. 安装PyTorch\npip install torch\n\n# 3. 安装DeepQuantum\npip install deepquantum\n```\n更多信息请访问其GitHub仓库。"
            ]
        }
    ];

    function getBotResponse(input) {
        const normalizedInput = input.toLowerCase();

        for (const intent of knowledgeBase) {
            if (intent.patterns.some(pattern => normalizedInput.includes(pattern.toLowerCase()))) {
                return intent.responses[Math.floor(Math.random() * intent.responses.length)];
            }
        }

        return "抱歉，我不太理解你的问题。你可以尝试问我关于VQE算法、DeepQuantum框架或量子化学的基础知识。";
    }
</script>
</body>
</html>
